let i=null,s=null,l=null,n=[];async function c(){try{const r=await(await fetch("/api/submissions")).json();r.success?(n=r.submissions,m(n),f(n),n.length>0&&u(n[0]._id)):document.getElementById("data-table-body").innerHTML='<tr><td colspan="10" class="border border-gray-300 px-4 py-8 text-center text-red-500">فشل في تحميل البيانات</td></tr>'}catch(e){console.error("Load data error:",e),document.getElementById("data-table-body").innerHTML='<tr><td colspan="10" class="border border-gray-300 px-4 py-8 text-center text-red-500">حدث خطأ في تحميل البيانات</td></tr>'}}function f(e){const r=e.length;let o=0,d=0;e.forEach(a=>{const p=parseFloat(a.field3)||0,b=parseFloat(a.field4)||0;o+=p,d+=b});const t=o-d;document.getElementById("total-records").textContent=r,document.getElementById("total-required").textContent=o.toFixed(2),document.getElementById("total-paid").textContent=d.toFixed(2),document.getElementById("remaining-amount").textContent=t.toFixed(2)}function m(e){const r=document.getElementById("data-table-body");if(e.length===0){r.innerHTML='<tr><td colspan="10" class="border border-gray-300 px-4 py-8 text-center text-gray-500">لا توجد بيانات محفوظة</td></tr>';return}const o=t=>new Date(t).toLocaleDateString("ar-EG",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),d=e.map(t=>`
        <tr class="hover:bg-gray-50 cursor-pointer ${l===t._id?"bg-blue-50":""}" onclick="selectRecord('${t._id}')">
          <td class="border border-gray-300 px-4 py-2">${t.field1||""}</td>
          <td class="border border-gray-300 px-4 py-2">${t.field2||""}</td>
          <td class="border border-gray-300 px-4 py-2">${t.field3||""}</td>
          <td class="border border-gray-300 px-4 py-2">${t.field4||""}</td>
          <td class="border border-gray-300 px-4 py-2">${t.field5||""}</td>
          <td class="border border-gray-300 px-4 py-2">${t.field6||""}</td>
          <td class="border border-gray-300 px-4 py-2">${t.field7||""}</td>
          <td class="border border-gray-300 px-4 py-2">${t.field8||""}</td>
          <td class="border border-gray-300 px-4 py-2 text-sm">${o(t.created_at)}</td>
          <td class="border border-gray-300 px-4 py-2">
            <div class="flex space-x-1 space-x-reverse">
              <button onclick="event.stopPropagation(); editSubmission('${t._id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs transition-colors">
                Edit
              </button>
              <button onclick="event.stopPropagation(); deleteSubmission('${t._id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs transition-colors">
                Delete
              </button>
            </div>
          </td>
        </tr>
      `).join("");r.innerHTML=d}function u(e){l=e;const r=n.find(d=>d._id===e);if(!r)return;document.getElementById("detail-record-id").textContent=r._id.slice(-6);for(let d=1;d<=8;d++)document.getElementById(`detail-field${d}`).textContent=r[`field${d}`]||"-";const o=d=>new Date(d).toLocaleDateString("ar-EG",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});document.getElementById("detail-created-at").textContent=o(r.created_at),m(n)}async function y(e){try{const o=await(await fetch(`/api/submissions/${e}`)).json();if(o.success){const d=o.submission;i=e,document.getElementById("edit-id").value=e;for(let t=1;t<=8;t++)document.getElementById(`edit-field${t}`).value=d[`field${t}`]||"";document.getElementById("edit-modal").classList.remove("hidden")}}catch(r){console.error("Edit error:",r),alert("حدث خطأ في تحميل بيانات السجل")}}function g(e){s=e,document.getElementById("delete-modal").classList.remove("hidden")}document.getElementById("add-record-btn").addEventListener("click",()=>{window.location.href="/"});document.getElementById("logout-btn").addEventListener("click",()=>{localStorage.removeItem("auth-token"),localStorage.removeItem("user-data"),window.location.href="/login"});document.getElementById("edit-detail-btn").addEventListener("click",()=>{l&&y(l)});document.getElementById("delete-detail-btn").addEventListener("click",()=>{l&&g(l)});document.getElementById("edit-form").addEventListener("submit",async e=>{e.preventDefault();const r=new FormData(e.target),o=Object.fromEntries(r.entries());delete o.field0;try{const d=localStorage.getItem("auth-token"),a=await(await fetch(`/api/submissions/${i}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d}`},body:JSON.stringify(o)})).json();a.success?(document.getElementById("edit-modal").classList.add("hidden"),c(),alert("تم تحديث السجل بنجاح")):alert(a.error||"فشل في تحديث السجل")}catch(d){console.error("Update error:",d),alert("حدث خطأ أثناء تحديث السجل")}});document.getElementById("cancel-edit").addEventListener("click",()=>{document.getElementById("edit-modal").classList.add("hidden")});document.getElementById("confirm-delete").addEventListener("click",async()=>{try{const e=localStorage.getItem("auth-token"),o=await(await fetch(`/api/submissions/${s}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}})).json();o.success?(document.getElementById("delete-modal").classList.add("hidden"),c(),alert("تم حذف السجل بنجاح")):alert(o.error||"فشل في حذف السجل")}catch(e){console.error("Delete error:",e),alert("حدث خطأ أثناء حذف السجل")}});document.getElementById("cancel-delete").addEventListener("click",()=>{document.getElementById("delete-modal").classList.add("hidden")});window.editSubmission=y;window.deleteSubmission=g;window.selectRecord=u;c();
